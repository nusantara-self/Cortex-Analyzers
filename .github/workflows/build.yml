name: build

on:
  push:
    branches:
      - develop
    tags:
      - "*"
  workflow_dispatch:
  schedule:
    # Every Month, the first day at 8:42 
    - cron: "42 8 1 * *"

jobs:
  generate-matrix:
    name: Generate Matrix
    runs-on: ubuntu-latest
    outputs:
      analyzers_matrix: ${{ steps.set-matrix.outputs.analyzers_matrix }}
      responders_matrix: ${{ steps.set-matrix.outputs.responders_matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List analyzer and responder directories and build matrices
        id: set-matrix
        run: |
          echo "Listing analyzer directories in 'analyzers/'..."
          analyzer_dirs=$(find analyzers -mindepth 1 -maxdepth 1 -type d -printf '%f\n') | head -3
          echo "Found analyzer directories:"
          echo "$analyzer_dirs"

          echo "Listing responder directories in 'responders/'..."
          responder_dirs=$(find responders -mindepth 1 -maxdepth 1 -type d -printf '%f\n') | head -3
          echo "Found responder directories:"
          echo "$responder_dirs"

          # Build JSON for analyzers (each object has a directory name)
          analyzer_json=$(echo "$analyzer_dirs" | jq -R -s -c 'split("\n")[:-1] | map({directory: .})')
          # Build JSON for responders
          responder_json=$(echo "$responder_dirs" | jq -R -s -c 'split("\n")[:-1] | map({directory: .})')
          
          # Wrap them in an "include" object
          analyzers_matrix=$(echo "$analyzer_json" | jq -c '{include: .}')
          responders_matrix=$(echo "$responder_json" | jq -c '{include: map(. + {component: "responders"})}')

          echo "Generated analyzers matrix: $analyzers_matrix"
          echo "Generated responders matrix: $responders_matrix"
          
          {
            echo "analyzers_matrix<<EOF"
            echo "$analyzers_matrix"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          
          {
            echo "responders_matrix<<EOF"
            echo "$responders_matrix"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build_analyzers:
    needs: generate-matrix
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.analyzers_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Analyzer to GHCR
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/cortex-analyzers/${{ matrix.directory }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -f ./analyzers/${{ matrix.directory }}/Dockerfile \
            --push \
            -t $IMAGE_NAME:latest \
            -t $IMAGE_NAME:${{ github.ref_name }} \
            ./analyzers/${{ matrix.directory }}

      - name: Make analyzer image public
        run: |
          PACKAGE=${{ matrix.directory }}
          VERSION_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/cortex-analyzers%2F$PACKAGE/versions \
            | jq '.[0].id')

          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/cortex-analyzers%2F$PACKAGE/versions/$VERSION_ID \
            -d '{"visibility":"public"}'

  build_responders:
    needs: generate-matrix
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.responders_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Responder to GHCR
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/cortex-responders/${{ matrix.directory }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -f ./responders/${{ matrix.directory }}/Dockerfile \
            --push \
            -t $IMAGE_NAME:latest \
            -t $IMAGE_NAME:${{ github.ref_name }} \
            ./responders/${{ matrix.directory }}

      - name: Make responder image public
        run: |
          PACKAGE=${{ matrix.directory }}
          VERSION_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/cortex-responders%2F$PACKAGE/versions \
            | jq '.[0].id')

          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/cortex-responders%2F$PACKAGE/versions/$VERSION_ID \
            -d '{"visibility":"public"}'
